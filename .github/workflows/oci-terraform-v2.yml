# =============================================================================
# OCI TERRAFORM CONTROLLER - VERSION 2.0
# =============================================================================
# Enhanced features:
# - âœ… Service dependency ordering (automatic topological sort)
# - âœ… Module change detection (re-plan affected services)
# - âœ… Parallel execution within dependency levels
# - âœ… Manual approval gates with plan review
# - âœ… Drift detection (scheduled runs)
# - âœ… Enhanced notifications
# - âœ… State locking
# =============================================================================

name: ğŸ¯ OCI Terraform Controller v2.0

run-name: "${{ github.event.pull_request.number && format('PR #{0}', github.event.pull_request.number) || github.ref_name }}"

on:
  push:
    paths: ['**/*.tfvars']
  
  pull_request:
    types: [opened, synchronize, reopened, closed]
    paths: ['**/*.tfvars']
  
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: write

env:
  TERRAFORM_VERSION: '1.5.6'
  PYTHON_VERSION: '3.11'
  ORCHESTRATOR_VERSION: '2.0'
  # Dynamic branch configuration
  FEATURE_BRANCHES: 'feature/,fix/,update/,hotfix/'
  DEFAULT_TARGET_BRANCH: 'Dev'

jobs:
  # ===========================================================================
  # JOB 1: AUTO-CREATE PR FROM FEATURE BRANCHES
  # ===========================================================================
  auto-create-pr:
    name: ğŸ”€ Auto-Create PR
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && 
      !contains(fromJSON('["refs/heads/Dev", "refs/heads/Staging", "refs/heads/Production", "refs/heads/main"]'), github.ref) &&
      !contains(github.event.head_commit.message, '[skip-ci]')
    
    steps:
      - name: ï¿½ Generate GitHub App Token
        id: auth
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GT_APP_ID }}
          private-key: ${{ secrets.GT_APP_PRIVATE_KEY }}
      
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: ğŸ” Detect Changes
        id: detect
        run: |
          set -euo pipefail
          
          echo "ğŸ” Detecting TFVARS file changes (DYNAMIC - any directory)..."
          
          # Detect changed .tfvars files across ENTIRE repo (NO WORKING_DIR filter!)
          changed_files=$(git diff --name-only HEAD~1 HEAD | grep '\.tfvars$' || true)
          
          if [[ -z "$changed_files" ]]; then
            echo "â­ï¸  No .tfvars files changed - skipping"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # Extract REGION dynamically from first changed file path (e.g., toronto/...)
          first_file=$(echo "$changed_files" | head -1)
          REGION=$(echo "$first_file" | cut -d'/' -f1)
          echo "region=$REGION" >> $GITHUB_OUTPUT
          echo "ğŸ“ Detected region: $REGION"
          
          # Extract changed services (2nd level directories: region/SERVICE/file.tfvars)
          SERVICES=$(echo "$changed_files" | cut -d'/' -f2 | sort -u | paste -sd',' -)
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "âœ… Changed services: $SERVICES"
          
          # Count files
          FILE_COUNT=$(echo "$changed_files" | wc -l | tr -d ' ')
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          
          # Store changed files for PR body
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$changed_files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Show which tfvars files changed
          echo "ğŸ“ Changed tfvars files (${FILE_COUNT}):"
          echo "$changed_files" | sed 's/^/  - /'
      
      - name: ğŸ”€ Create Pull Request
        if: steps.detect.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          set -euo pipefail
          
          current_branch="${{ github.ref_name }}"
          
          # Skip if push is to an environment branch  
          if echo "$current_branch" | grep -qE "^(Dev|Staging|Production|main)$"; then
            echo "â­ï¸ Skipping PR creation - push to environment branch: ${current_branch}"
            exit 0
          fi
          
          # Get changed files list
          changed_files="${{ steps.detect.outputs.changed_files }}"
          
          # Detect target branch dynamically (default to Dev)
          target_branch="Dev"
          
          # Extract values
          SERVICES="${{ steps.detect.outputs.services }}"
          FILE_COUNT="${{ steps.detect.outputs.file_count }}"
          REGION="${{ steps.detect.outputs.region }}"
          
          echo "ğŸ¯ FINAL Target Branch: ${target_branch}"
          echo "ğŸ“ PR will be: ${current_branch} â†’ ${target_branch}"
          
          # Check if PR already exists for this branch â†’ target branch combination
          existing_pr=$(gh pr list --head "${{ github.ref_name }}" --base "${target_branch}" --state open --json number --jq '.[0].number // ""')
          
          if [[ -n "$existing_pr" ]]; then
            echo "â„¹ï¸ PR #$existing_pr already exists (${current_branch} â†’ ${target_branch})"
            exit 0
          fi
          
          # Create PR with dynamically determined target branch
          cat > pr_body.md << EOF
          ## ğŸ”§ OCI Terraform Configuration Update
          
          **ğŸ“Š Summary:**
          - Region: \`${REGION}\`
          - Services: \`${SERVICES}\`
          - Target Branch: \`${target_branch}\`
          - Changed files: ${FILE_COUNT}
          - Source Branch: \`${{ github.ref_name }}\`
          
          **ğŸ“ Files:**
          $(echo "$changed_files" | sed 's/^/- `/' | sed 's/$/`/')
          
          **ğŸ”„ Automated Workflow:**
          1. âœ… Terraform plan with dependency ordering
          2. ğŸ“‹ Review plan results (auto-posted below)
          3. ğŸ‘€ Human review & approval required
          4. ğŸš€ Merge to \`${target_branch}\` to trigger apply
          5. ğŸ¯ Terraform apply (automatic after merge)
          
          ---
          *ğŸ¤– Auto-generated PR - DO NOT EDIT*
          EOF
          
          gh pr create \
            --title "ğŸ”§ OCI Terraform: ${REGION}/${SERVICES} [${target_branch}]" \
            --body "$(cat pr_body.md)" \
            --head "${{ github.ref_name }}" \
            --base "${target_branch}"
          
          echo "âœ… PR created successfully targeting ${target_branch}"
      
      - name: ğŸ’¬ Post Initial PR Comment
        if: steps.detect.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          target_branch="Dev"
          PR_NUM=$(gh pr list --head ${{ github.ref_name }} --base "${target_branch}" --state open --json number --jq '.[0].number')
          
          if [ -n "$PR_NUM" ]; then
            echo "Posting initial status comment to PR #$PR_NUM..."
            
            echo "## â³ Terraform Plan Running..." > /tmp/pr-comment.txt
            echo "" >> /tmp/pr-comment.txt
            echo "The v2.0 orchestrator is analyzing your changes and generating a terraform plan." >> /tmp/pr-comment.txt
            echo "" >> /tmp/pr-comment.txt
            echo "**Features enabled:**" >> /tmp/pr-comment.txt
            echo "- âœ… Dependency-aware execution order" >> /tmp/pr-comment.txt
            echo "- âœ… Parallel processing capability" >> /tmp/pr-comment.txt
            echo "- âœ… Module change detection" >> /tmp/pr-comment.txt
            echo "" >> /tmp/pr-comment.txt
            echo "Results will be posted here shortly..." >> /tmp/pr-comment.txt
            
            gh pr comment $PR_NUM --body-file /tmp/pr-comment.txt
            echo "âœ… Status comment posted!"
          else
            echo "âš ï¸ Could not find PR number"
          fi

  # ===========================================================================
  # JOB 2: TERRAFORM PLAN (ON PR) - WITH DEPENDENCY ORDERING
  # ===========================================================================
  terraform-plan:
    name: ğŸ“‹ Terraform Plan (v2)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' && 
      contains(fromJSON('["opened", "synchronize", "reopened"]'), github.event.action)
    
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
      plan_summary: ${{ steps.plan.outputs.summary }}
    
    steps:
      - name: ï¿½ Generate GitHub App Token
        id: auth
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GT_APP_ID }}
          private-key: ${{ secrets.GT_APP_PRIVATE_KEY }}
      
      - name: ï¿½ğŸ“‹ PR Details
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” TERRAFORM PLAN v2.0 - WITH DEPENDENCY ORDERING"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
          echo "From: ${{ github.head_ref }} â†’ ${{ github.base_ref }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0
      
      - name: ğŸ” Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          EOF
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          
          echo "TF_VAR_tenancy_ocid=${{ secrets.OCI_TENANCY }}" >> $GITHUB_ENV
          echo "TF_VAR_user_ocid=${{ secrets.OCI_USER }}" >> $GITHUB_ENV
          echo "TF_VAR_region=${{ secrets.OCI_REGION }}" >> $GITHUB_ENV
          echo "TF_VAR_fingerprint=${{ secrets.OCI_FINGERPRINT }}" >> $GITHUB_ENV
          echo "TF_VAR_private_key_path=$HOME/.oci/oci_api_key.pem" >> $GITHUB_ENV
      
      - name: ï¿½ Debug OCI Authentication
        run: |
          echo "===================================================="
          echo "ğŸ” OCI AUTHENTICATION DEBUG"
          echo "===================================================="
          
          # Check files exist
          echo "ğŸ“ Checking OCI configuration files..."
          ls -la ~/.oci/
          
          # Check key format (first and last lines)
          echo ""
          echo "ğŸ”‘ Private key format check:"
          echo "First line: $(head -1 ~/.oci/oci_api_key.pem)"
          echo "Last line: $(tail -1 ~/.oci/oci_api_key.pem)"
          echo "Line count: $(wc -l < ~/.oci/oci_api_key.pem)"
          
          # Verify key permissions
          echo ""
          echo "ğŸ”’ Key permissions:"
          stat -f "%A" ~/.oci/oci_api_key.pem 2>/dev/null || stat -c "%a" ~/.oci/oci_api_key.pem
          
          # Calculate fingerprint from private key and compare
          echo ""
          echo "ğŸ” Fingerprint Verification:"
          echo "Expected fingerprint (from secret): ${TF_VAR_fingerprint}"
          
          # Calculate actual fingerprint from the key
          echo "Calculating fingerprint from private key..."
          CALCULATED_FP=$(openssl rsa -pubout -outform DER -in ~/.oci/oci_api_key.pem 2>/dev/null | openssl md5 -c | awk '{print $2}')
          echo "Calculated fingerprint: $CALCULATED_FP"
          
          if [ "$TF_VAR_fingerprint" = "$CALCULATED_FP" ]; then
            echo "âœ… Fingerprints MATCH!"
          else
            echo "âŒ FINGERPRINT MISMATCH!"
            echo "   This is why you're getting 401 errors!"
            echo "   Your private key doesn't match the fingerprint in secrets."
          fi
          
          # Check config content (masked)
          echo ""
          echo "âš™ï¸ OCI Config (masked):"
          echo "User OCID: ${TF_VAR_user_ocid:0:20}..."
          echo "Tenancy OCID: ${TF_VAR_tenancy_ocid:0:20}..."
          echo "Region: $TF_VAR_region"
          echo "Fingerprint: ${TF_VAR_fingerprint:0:10}..."
          
          # Install OCI CLI for testing
          echo ""
          echo "ğŸ“¦ Installing OCI CLI for auth test..."
          pip install -q oci-cli
          
          # Test OCI authentication
          echo ""
          echo "âœ… Testing OCI authentication..."
          if oci iam region list --config-file ~/.oci/config 2>&1 | grep -q "us-ashburn-1"; then
            echo "âœ… OCI authentication SUCCESSFUL!"
          else
            echo "âŒ OCI authentication FAILED!"
            echo ""
            echo "Full error output:"
            oci iam region list --config-file ~/.oci/config 2>&1 || true
          fi
          
          echo "===================================================="
      
      - name: ï¿½ğŸ” Configure AWS Credentials (State Backend)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“¦ Install Dependencies
        run: pip install -r scripts/requirements.txt
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: ğŸ” Detect Changed Files & Region (PR API)
        id: detect-region
        uses: actions/github-script@v7
        with:
          script: |
            let changedFiles = [];
            
            if (context.eventName === 'pull_request') {
              // âœ… Use GitHub PR API - more reliable than git diff!
              core.info('ğŸ“‹ Getting changed files from PR API...');
              
              const files = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                per_page: 100
              });
              
              changedFiles = files.data
                .map(f => f.filename)
                .filter(f => f.endsWith('.tfvars'));
              
              core.info(`âœ… Found ${changedFiles.length} changed .tfvars files via PR API`);
            }
            
            if (changedFiles.length === 0) {
              core.setFailed('âŒ No .tfvars files changed');
              return;
            }
            
            // Extract region from first changed file
            const firstFile = changedFiles[0];
            const region = firstFile.split('/')[0];
            
            core.info(`ğŸ“ Detected region: ${region}`);
            core.info(`ğŸ“ Changed files: ${changedFiles.join(', ')}`);
            
            // Set outputs
            core.setOutput('region', region);
            core.setOutput('changed_files', changedFiles.join('\n'));
            core.setOutput('file_count', changedFiles.length)
      
      - name: ğŸ“‹ Run Terraform Plan (v2 with dependencies)
        id: plan
        run: |
          REGION_DIR="${{ steps.detect-region.outputs.region }}"
          
          # Map directory name to OCI region code
          case "$REGION_DIR" in
            toronto)
              OCI_REGION="ca-toronto-1"
              ;;
            ashburn)
              OCI_REGION="us-ashburn-1"
              ;;
            phoenix)
              OCI_REGION="us-phoenix-1"
              ;;
            london)
              OCI_REGION="uk-london-1"
              ;;
            frankfurt)
              OCI_REGION="eu-frankfurt-1"
              ;;
            *)
              # Default or use secrets
              OCI_REGION="${{ secrets.OCI_REGION }}"
              echo "âš ï¸  Unknown region directory: $REGION_DIR, using default: $OCI_REGION"
              ;;
          esac
          
          echo "ğŸ¯ Running Terraform Plan"
          echo "   Directory: $REGION_DIR"
          echo "   OCI Region: $OCI_REGION"
          echo "   Changed files: ${{ steps.detect-region.outputs.file_count }}"
          
          # Save changed files for orchestrator
          echo '${{ steps.detect-region.outputs.changed_files }}' > /tmp/changed-files.txt
          
          python3 scripts/oci-terraform-orchestrator-v2.py \
            --action plan \
            --working-dir "${{ github.workspace }}/${REGION_DIR}" \
            --region "$OCI_REGION" \
            --parallel \
            --max-workers 3 \
            --debug
          
          # Check if there are changes
          if grep -q "No Infrastructure Changes" terraform-results.md; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ’¬ Post Plan Results to PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.auth.outputs.token }}
          script: |
            const fs = require('fs');
            
            let comment = '## ğŸ“‹ Terraform Plan Results\n\n';
            
            try {
              const results = fs.readFileSync('terraform-results.md', 'utf8');
              comment += results;
            } catch (error) {
              comment += `## âŒ Plan Failed\n\nFailed to generate plan. Check workflow logs.\n\nError: ${error.message}`;
            }
            
            // Add v2 specific notes
            comment += `\n\n## ğŸ¯ Version 2.0 Features\n\n`;
            comment += `This plan was generated with:\n`;
            comment += `- âœ… Dependency-aware execution order\n`;
            comment += `- âœ… Module change detection\n`;
            comment += `- âœ… Parallel execution capability\n`;
            comment += `- âœ… Enhanced error recovery\n\n`;
            
            comment += `## âœ… Pre-Merge Checklist\n\n`;
            comment += `- [ ] Execution order respects dependencies\n`;
            comment += `- [ ] No unexpected resource deletions\n`;
            comment += `- [ ] Module changes reviewed (if any)\n`;
            comment += `- [ ] Plan output matches expectations\n`;
            comment += `\n**âš ï¸  Merging will trigger automatic apply**\n`;
            
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            comment += `\n---\nğŸ”— [View Workflow Run](${runUrl})`;
            
            // Update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('Terraform Plan Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
      
      - name: ğŸ“¤ Upload Plan Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-v2-${{ github.event.pull_request.number || github.run_number }}
          path: |
            terraform-results.md
            terraform-audit.json
          retention-days: 30

  # ===========================================================================
  # JOB 3: TERRAFORM APPLY (ON MERGE) - WITH DEPENDENCY ORDERING
  # ===========================================================================
  terraform-apply:
    name: ğŸš€ Terraform Apply (v2)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'closed' && 
      github.event.pull_request.merged == true
    
    steps:
      - name: ï¿½ Generate GitHub App Token
        id: auth
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GT_APP_ID }}
          private-key: ${{ secrets.GT_APP_PRIVATE_KEY }}
      
      - name: ï¿½ğŸš€ Apply Details
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ TERRAFORM APPLY v2.0 - WITH DEPENDENCY ORDERING"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
          echo "Base Branch: ${{ github.event.pull_request.base.ref }}"
          echo "Merged By: @${{ github.event.pull_request.merged_by.login }}"
          echo "Commit: ${{ github.event.pull_request.merge_commit_sha }}"
          echo "Parallel: enabled"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}
          fetch-depth: 0
      
      - name: ğŸ” Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          EOF
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          
          echo "TF_VAR_tenancy_ocid=${{ secrets.OCI_TENANCY }}" >> $GITHUB_ENV
          echo "TF_VAR_user_ocid=${{ secrets.OCI_USER }}" >> $GITHUB_ENV
          echo "TF_VAR_region=${{ secrets.OCI_REGION }}" >> $GITHUB_ENV
          echo "TF_VAR_fingerprint=${{ secrets.OCI_FINGERPRINT }}" >> $GITHUB_ENV
          echo "TF_VAR_private_key_path=$HOME/.oci/oci_api_key.pem" >> $GITHUB_ENV
      
      - name: ï¿½ Debug OCI Authentication
        run: |
          echo "===================================================="
          echo "ğŸ” OCI AUTHENTICATION DEBUG (APPLY)"
          echo "===================================================="
          
          echo "ğŸ“ Checking OCI configuration files..."
          ls -la ~/.oci/
          
          echo ""
          echo "ğŸ”‘ Private key format check:"
          echo "First line: $(head -1 ~/.oci/oci_api_key.pem)"
          echo "Last line: $(tail -1 ~/.oci/oci_api_key.pem)"
          echo "Line count: $(wc -l < ~/.oci/oci_api_key.pem)"
          
          echo ""
          echo "âš™ï¸  OCI Config (masked):"
          echo "User OCID: ${TF_VAR_user_ocid:0:20}..."
          echo "Tenancy OCID: ${TF_VAR_tenancy_ocid:0:20}..."
          echo "Region: $TF_VAR_region"
          echo "Fingerprint: ${TF_VAR_fingerprint:0:10}..."
          
          echo ""
          echo "ğŸ“¦ Installing OCI CLI for auth test..."
          pip install -q oci-cli
          
          echo ""
          echo "âœ… Testing OCI authentication..."
          if oci iam region list --config-file ~/.oci/config 2>&1 | grep -q "us-ashburn-1"; then
            echo "âœ… OCI authentication SUCCESSFUL!"
          else
            echo "âŒ OCI authentication FAILED!"
            echo ""
            echo "Full error output:"
            oci iam region list --config-file ~/.oci/config 2>&1 || true
          fi
          
          echo "===================================================="
      
      - name: ï¿½ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“¦ Install Dependencies
        run: pip install -r scripts/requirements.txt
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: ğŸ” Detect Changed Files & Region (Merge Commit)
        id: detect-region
        uses: actions/github-script@v7
        with:
          script: |
            let changedFiles = [];
            
            try {
              // âœ… For merge commits, use GitHub API to get commit details
              core.info('ğŸ“‹ Fetching merge commit details from GitHub API...');
              
              const commit = await github.rest.repos.getCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.sha
              });
              
              // Get all changed files from the commit
              changedFiles = commit.data.files
                .map(f => f.filename)
                .filter(f => f.endsWith('.tfvars'));
              
              core.info(`âœ… Found ${changedFiles.length} changed .tfvars files from commit`);
              
            } catch (error) {
              // Fallback to git diff if API fails
              core.warning(`âš ï¸ GitHub API failed, falling back to git diff: ${error.message}`);
              const { execSync } = require('child_process');
              const output = execSync('git diff --name-only HEAD^ HEAD').toString();
              changedFiles = output.split('\n').filter(f => f.endsWith('.tfvars'));
            }
            
            if (changedFiles.length === 0) {
              core.setFailed('âŒ No .tfvars files changed in this merge');
              return;
            }
            
            // Extract region from first changed file
            const firstFile = changedFiles[0];
            const region = firstFile.split('/')[0];
            
            // Extract service names (2nd level directories)
            const services = [...new Set(
              changedFiles
                .map(f => f.split('/')[1])
                .filter(s => s)
            )].join(', ');
            
            core.info(`ğŸ“ Detected region: ${region}`);
            core.info(`ğŸ¯ Services: ${services}`);
            core.info(`ğŸ“ Changed files (${changedFiles.length}): ${changedFiles.join(', ')}`);
            
            // Set outputs
            core.setOutput('region', region);
            core.setOutput('services', services);
            core.setOutput('changed_files', changedFiles.join('\n'));
            core.setOutput('file_count', changedFiles.length)
      
      - name: ğŸš€ Run Terraform Apply (v2 with dependencies)
        id: apply
        run: |
          PARALLEL_FLAG="--parallel"
          REGION_DIR="${{ steps.detect-region.outputs.region }}"
          
          # Map directory name to OCI region code
          case "$REGION_DIR" in
            toronto)
              OCI_REGION="ca-toronto-1"
              ;;
            ashburn)
              OCI_REGION="us-ashburn-1"
              ;;
            phoenix)
              OCI_REGION="us-phoenix-1"
              ;;
            london)
              OCI_REGION="uk-london-1"
              ;;
            frankfurt)
              OCI_REGION="eu-frankfurt-1"
              ;;
            *)
              OCI_REGION="${{ secrets.OCI_REGION }}"
              echo "âš ï¸  Unknown region directory: $REGION_DIR, using default: $OCI_REGION"
              ;;
          esac
          
          echo "ğŸ¯ Running Terraform Apply"
          echo "   Directory: $REGION_DIR"
          echo "   OCI Region: $OCI_REGION"
          echo "   Services: ${{ steps.detect-region.outputs.services }}"
          echo "   Changed files: ${{ steps.detect-region.outputs.file_count }}"
          
          # Save changed files for orchestrator
          echo '${{ steps.detect-region.outputs.changed_files }}' > /tmp/changed-files.txt
          
          python3 scripts/oci-terraform-orchestrator-v2.py \
            --action apply \
            --working-dir "${{ github.workspace }}/${REGION_DIR}" \
            --region "$OCI_REGION" \
            $PARALLEL_FLAG \
            --max-workers 3 \
            --debug
      
      - name: ï¿½ Post Apply Results to PR
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.auth.outputs.token }}
          script: |
            const fs = require('fs');
            const prNumber = context.payload.pull_request.number;
            const success = '${{ steps.apply.outcome }}' === 'success';
            
            let comment = success 
              ? '## âœ… Terraform Apply Completed Successfully\n\n'
              : '## âŒ Terraform Apply Failed\n\n';
            
            comment += `**PR**: #${prNumber}\n`;
            comment += `**Base Branch**: ${{ github.event.pull_request.base.ref }}\n`;
            comment += `**Merged By**: @${{ github.event.pull_request.merged_by.login }}\n`;
            comment += `**Commit**: \`${'${{ github.event.pull_request.merge_commit_sha }}'.substring(0, 7)}\`\n`;
            comment += `**Region**: ${{ steps.detect-region.outputs.region }}\n`;
            comment += `**Services**: ${{ steps.detect-region.outputs.services }}\n\n`;
            
            if (fs.existsSync('terraform-results.md')) {
              const results = fs.readFileSync('terraform-results.md', 'utf8');
              comment += '### ğŸ“Š Apply Results\n\n';
              comment += results;
            }
            
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            comment += `\n\n---\nğŸ”— [View Workflow Run](${runUrl})`;
            
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: ï¿½ğŸ“¤ Upload Apply Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-apply-v2-${{ github.run_number }}-${{ github.ref_name }}
          path: |
            terraform-results.md
            terraform-audit.json
          retention-days: 90
      
      - name: ğŸ“Š Create Deployment Summary
        if: always()
        run: |
          echo "## ğŸš€ Terraform Apply Summary (v2.0)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Orchestrator:** v${{ env.ORCHESTRATOR_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f terraform-results.md ]; then
            cat terraform-results.md >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ¯ Final Status
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [[ "${{ steps.apply.outcome }}" == "success" ]]; then
            echo "âœ… TERRAFORM APPLY SUCCESSFUL (v2.0)"
          else
            echo "âŒ TERRAFORM APPLY FAILED (v2.0)"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  

