# =============================================================================
# REUSABLE WORKFLOW - OCI TERRAFORM CONTROLLER V2.0
# =============================================================================
# This workflow can be called from any repository
# Prevents workflow drift and centralizes maintenance
# =============================================================================

name: ğŸ”„ OCI Terraform Reusable Workflow v2.0

on:
  workflow_call:
    inputs:
      working_dir:
        description: 'Working directory containing service folders (e.g., toronto)'
        required: true
        type: string
      terraform_version:
        description: 'Terraform version to use'
        required: false
        type: string
        default: '1.5.6'
      python_version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'
      parallel:
        description: 'Enable parallel execution'
        required: false
        type: boolean
        default: true
      max_workers:
        description: 'Maximum parallel workers'
        required: false
        type: number
        default: 3
      base_branch:
        description: 'Base branch for PR (Dev, Staging, Production)'
        required: false
        type: string
        default: 'Dev'
    
    secrets:
      GT_APP_ID:
        description: 'GitHub App ID for PR creation'
        required: true
      GT_APP_PRIVATE_KEY:
        description: 'GitHub App private key'
        required: true
      OCI_USER:
        description: 'OCI User OCID'
        required: true
      OCI_FINGERPRINT:
        description: 'OCI API key fingerprint'
        required: true
      OCI_TENANCY:
        description: 'OCI Tenancy OCID'
        required: true
      OCI_REGION:
        description: 'OCI Region'
        required: true
      OCI_PRIVATE_KEY:
        description: 'OCI Private key content'
        required: true
      AWS_ROLE_ARN:
        description: 'AWS role ARN for state backend'
        required: true
      AWS_REGION:
        description: 'AWS region for state backend'
        required: true
    
    outputs:
      has_changes:
        description: 'Whether terraform detected any changes'
        value: ${{ jobs.terraform-plan.outputs.has_changes }}
      services:
        description: 'List of changed services'
        value: ${{ jobs.detect-changes.outputs.services }}

jobs:
  # ===========================================================================
  # JOB 1: DETECT CHANGES
  # ===========================================================================
  detect-changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    
    outputs:
      has_changes: ${{ steps.detect.outputs.has_changes }}
      services: ${{ steps.detect.outputs.services }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ” Detect TFVARS Changes
        id: detect
        run: |
          echo "ğŸ” Detecting TFVARS file changes only..."
          
          BASE_REF="${{ github.event.pull_request.base.sha || 'HEAD^' }}"
          echo "ğŸ“Š Comparing against: $BASE_REF"
          
          if git diff --name-only $BASE_REF | grep -qE "^${{ inputs.working_dir }}/.*\.tfvars$"; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            SERVICES=$(git diff --name-only $BASE_REF | grep "^${{ inputs.working_dir }}/.*\.tfvars$" | cut -d'/' -f2 | sort -u | tr '\n' ',' | sed 's/,$//')
            echo "services=$SERVICES" >> $GITHUB_OUTPUT
            echo "âœ… Changed services: $SERVICES"
            
            echo "ğŸ“ Changed tfvars files:"
            git diff --name-only $BASE_REF | grep "^${{ inputs.working_dir }}/.*\.tfvars$"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  No tfvars changes detected"
          fi
  
  # ===========================================================================
  # JOB 2: AUTO-CREATE PR (FOR FEATURE BRANCHES)
  # ===========================================================================
  auto-create-pr:
    name: ğŸ”€ Auto-Create PR
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.has_changes == 'true' &&
      (startsWith(github.ref, 'refs/heads/feature/') || 
       startsWith(github.ref, 'refs/heads/fix/') || 
       startsWith(github.ref, 'refs/heads/update/') ||
       startsWith(github.ref, 'refs/heads/hotfix/'))
    
    steps:
      - name: ğŸ”‘ Generate GitHub App Token
        id: auth
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GT_APP_ID }}
          private-key: ${{ secrets.GT_APP_PRIVATE_KEY }}
      
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ steps.auth.outputs.token }}
          fetch-depth: 0
      
      - name: ğŸ”€ Create Pull Request
        env:
          GH_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          if gh pr list --head ${{ github.ref_name }} --base ${{ inputs.base_branch }} --state open | grep -q "${{ github.ref_name }}"; then
            echo "âœ… Pull Request already exists"
            gh pr list --head ${{ github.ref_name }} --base ${{ inputs.base_branch }} --state open
          else
            CHANGED_FILES=$(git diff --name-only HEAD^ | grep "^${{ inputs.working_dir }}/.*\.tfvars$")
            FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l | tr -d ' ')
            SERVICES="${{ needs.detect-changes.outputs.services }}"
            
            echo "## OCI Terraform Configuration Update (v2.0)" > /tmp/pr_body.md
            echo "" >> /tmp/pr_body.md
            echo "**Summary:**" >> /tmp/pr_body.md
            echo "- **Services:** \`${SERVICES}\`" >> /tmp/pr_body.md
            echo "- **Environment:** \`${{ inputs.base_branch }}\`" >> /tmp/pr_body.md
            echo "- **Changed Files:** ${FILE_COUNT}" >> /tmp/pr_body.md
            echo "- **Source Branch:** \`${{ github.ref_name }}\`" >> /tmp/pr_body.md
            echo "" >> /tmp/pr_body.md
            echo "**Changed Files:**" >> /tmp/pr_body.md
            echo "$CHANGED_FILES" | sed 's/^/- `/' | sed 's/$/`/' >> /tmp/pr_body.md
            echo "" >> /tmp/pr_body.md
            echo "**Automated Workflow (v2.0):**" >> /tmp/pr_body.md
            echo "1. Terraform Plan with dependency ordering" >> /tmp/pr_body.md
            echo "2. Review plan results (auto-posted below)" >> /tmp/pr_body.md
            echo "3. Human review & approval required" >> /tmp/pr_body.md
            echo "4. Merge to trigger terraform apply" >> /tmp/pr_body.md
            echo "5. Apply with dependency-aware execution" >> /tmp/pr_body.md
            echo "" >> /tmp/pr_body.md
            echo "---" >> /tmp/pr_body.md
            echo "*Auto-generated PR - Powered by OCI Terraform Orchestrator v2.0*" >> /tmp/pr_body.md
            
            gh pr create \
              --base ${{ inputs.base_branch }} \
              --head ${{ github.ref_name }} \
              --title "OCI Terraform: ${SERVICES} [${{ inputs.base_branch }}]" \
              --body-file /tmp/pr_body.md
            
            echo "âœ… Pull Request created successfully!"
          fi
      
      - name: ğŸ’¬ Post Status Comment
        env:
          GH_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          PR_NUM=$(gh pr list --head ${{ github.ref_name }} --base ${{ inputs.base_branch }} --state open --json number --jq '.[0].number')
          
          if [ -n "$PR_NUM" ]; then
            echo "## Terraform Plan Running..." > /tmp/pr-comment.txt
            echo "" >> /tmp/pr-comment.txt
            echo "The v2.0 orchestrator is analyzing your changes and generating a terraform plan." >> /tmp/pr-comment.txt
            echo "" >> /tmp/pr-comment.txt
            echo "**Features enabled:**" >> /tmp/pr-comment.txt
            echo "- Dependency-aware execution order" >> /tmp/pr-comment.txt
            echo "- Parallel processing capability" >> /tmp/pr-comment.txt
            echo "- Module change detection" >> /tmp/pr-comment.txt
            echo "" >> /tmp/pr-comment.txt
            echo "Results will be posted here shortly..." >> /tmp/pr-comment.txt
            
            gh pr comment $PR_NUM --body-file /tmp/pr-comment.txt
            echo "âœ… Status comment posted!"
          fi
  
  # ===========================================================================
  # JOB 3: TERRAFORM PLAN
  # ===========================================================================
  terraform-plan:
    name: ğŸ“‹ Terraform Plan
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.has_changes == 'true' &&
      (github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch')
    
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ” Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          EOF
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          
          echo "TF_VAR_tenancy_ocid=${{ secrets.OCI_TENANCY }}" >> $GITHUB_ENV
          echo "TF_VAR_user_ocid=${{ secrets.OCI_USER }}" >> $GITHUB_ENV
          echo "TF_VAR_region=${{ secrets.OCI_REGION }}" >> $GITHUB_ENV
          echo "TF_VAR_fingerprint=${{ secrets.OCI_FINGERPRINT }}" >> $GITHUB_ENV
          echo "TF_VAR_private_key_path=$HOME/.oci/oci_api_key.pem" >> $GITHUB_ENV
      
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: ğŸ“¦ Install Dependencies
        run: pip install -r scripts/requirements.txt
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}
      
      - name: ğŸ“‹ Run Terraform Plan
        id: plan
        run: |
          BASE_REF="${{ github.event.pull_request.base.sha || 'HEAD^' }}"
          
          python3 scripts/oci-terraform-orchestrator-v2.py \
            --action plan \
            --working-dir "${{ github.workspace }}/${{ inputs.working_dir }}" \
            --base-ref "$BASE_REF" \
            --region "${{ secrets.OCI_REGION }}" \
            ${{ inputs.parallel && '--parallel' || '' }} \
            --max-workers ${{ inputs.max_workers }} \
            --debug
          
          if grep -q "No Infrastructure Changes" terraform-results.md; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ’¬ Post Plan Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let comment = fs.readFileSync('terraform-results.md', 'utf8');
            
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            comment += `\n\n---\nğŸ”— [View Workflow Run](${runUrl})`;
            
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('Terraform Plan Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
      
      - name: ğŸ“¤ Upload Plan Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.run_number }}
          path: |
            terraform-results.md
            terraform-audit.json
          retention-days: 30
  
  # ===========================================================================
  # JOB 4: TERRAFORM APPLY
  # ===========================================================================
  terraform-apply:
    name: ğŸš€ Terraform Apply
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.has_changes == 'true' &&
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/Dev' || 
       github.ref == 'refs/heads/Staging' || 
       github.ref == 'refs/heads/Production')
    
    environment:
      name: ${{ github.ref == 'refs/heads/Production' && 'production' || github.ref == 'refs/heads/Staging' && 'staging' || 'development' }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ” Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          EOF
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          
          echo "TF_VAR_tenancy_ocid=${{ secrets.OCI_TENANCY }}" >> $GITHUB_ENV
          echo "TF_VAR_user_ocid=${{ secrets.OCI_USER }}" >> $GITHUB_ENV
          echo "TF_VAR_region=${{ secrets.OCI_REGION }}" >> $GITHUB_ENV
          echo "TF_VAR_fingerprint=${{ secrets.OCI_FINGERPRINT }}" >> $GITHUB_ENV
          echo "TF_VAR_private_key_path=$HOME/.oci/oci_api_key.pem" >> $GITHUB_ENV
      
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: ğŸ“¦ Install Dependencies
        run: pip install -r scripts/requirements.txt
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}
      
      - name: ğŸš€ Run Terraform Apply
        run: |
          python3 scripts/oci-terraform-orchestrator-v2.py \
            --action apply \
            --working-dir "${{ github.workspace }}/${{ inputs.working_dir }}" \
            --base-ref "HEAD^" \
            --region "${{ secrets.OCI_REGION }}" \
            ${{ inputs.parallel && '--parallel' || '' }} \
            --max-workers ${{ inputs.max_workers }} \
            --debug
      
      - name: ğŸ“¤ Upload Apply Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-apply-${{ github.run_number }}
          path: |
            terraform-results.md
            terraform-audit.json
          retention-days: 90
