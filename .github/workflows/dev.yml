name: Deploy to OCI with Terraform

on:
  push:
    branches:
      - Dev
  workflow_dispatch: # Allows manual trigger

jobs:
  detect_changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.set-services.outputs.services }}
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Filter Paths
      id: filter
      uses: dorny/paths-filter@v3
      with:
        filters: |
          identity:
            - 'toronto/identity/**'
          network:
            - 'toronto/network/**'
          storage:
            - 'toronto/storage/**'

    - name: Determine Changed Services
      id: set-services
      run: |
        SERVICES=()
        if [[ "${{ steps.filter.outputs.identity }}" == "true" ]]; then
          SERVICES+=('"identity"')
        fi
        if [[ "${{ steps.filter.outputs.network }}" == "true" ]]; then
          SERVICES+=('"network"')
        fi
        if [[ "${{ steps.filter.outputs.storage }}" == "true" ]]; then
          SERVICES+=('"storage"')
        fi

        SERVICES_JSON="{\"services\": [$(IFS=,; echo "${SERVICES[*]}")]}"

        echo "services=$SERVICES_JSON" >> $GITHUB_ENV
        echo "services=$SERVICES_JSON" >> $GITHUB_OUTPUT

  terraform_plan:
    needs: detect_changes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect_changes.outputs.services).services }}
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Install Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.10.5

    - name: Set Up OCI Environment Variables
      run: |
        echo "OCI_TENANCY=${{ secrets.OCI_TENANCY }}" >> $GITHUB_ENV
        echo "OCI_USER=${{ secrets.OCI_USER }}" >> $GITHUB_ENV
        echo "OCI_REGION=${{ secrets.OCI_REGION }}" >> $GITHUB_ENV
        echo "OCI_FINGERPRINT=${{ secrets.OCI_FINGERPRINT }}" >> $GITHUB_ENV
        echo "${{ secrets.OCI_PRIVATE_KEY }}" > oci_api_key.pem
        chmod 600 oci_api_key.pem
        echo "OCI_PRIVATE_KEY_PATH=$PWD/oci_api_key.pem" >> $GITHUB_ENV

    - name: Terraform Init
      run: |
        cd toronto/${{ matrix.service }}
        terraform init 

    - name: Terraform Plan
      run: |
        cd toronto/${{ matrix.service }}
        terraform plan -out=terraform.tfplan -var="tenancy_ocid=${{ secrets.OCI_TENANCY }}" \
                                               -var="user_ocid=${{ secrets.OCI_USER }}" \
                                               -var="region=${{ secrets.OCI_REGION }}" \
                                               -var="fingerprint=${{ secrets.OCI_FINGERPRINT }}" \
                                               -var="private_key_path=$OCI_PRIVATE_KEY_PATH"

    - name: Upload Terraform Plan
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan-${{ matrix.service }}
        path: toronto/${{ matrix.service }}/terraform.tfplan

    - name: Set Terraform Plan Outputs
      id: set-plan-output
      run: |
        echo "services=${{ needs.detect_changes.outputs.services }}" >> $GITHUB_ENV
        echo "services=${{ needs.detect_changes.outputs.services }}" >> $GITHUB_OUTPUT

  terraform_apply:
    needs: terraform_plan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect_changes.outputs.services).services }}
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Install Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.10.5

    - name: Download Terraform Plan
      uses: actions/download-artifact@v4
      with:
        name: terraform-plan-${{ matrix.service }}
        path: toronto/${{ matrix.service }}

    - name: Terraform Apply (Requires Approval)
      run: |
        cd toronto/${{ matrix.service }}
        terraform apply terraform.tfplan
